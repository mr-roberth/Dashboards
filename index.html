<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Monitoreo de Caña de Azúcar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #10b981;
            --primary-dark: #059669;
            --primary-light: #d1fae5;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --success-color: #10b981;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-700: #374151;
            --gray-900: #111827;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header */
        .header {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo i {
            font-size: 2rem;
            color: var(--primary-color);
        }
        
        .logo h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--gray-900);
        }
        
        .logo span {
            color: var(--primary-color);
        }
        
        /* Auth Section */
        .auth-section {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .auth-form {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 2rem auto;
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        /* Main Content */
        .main-content {
            display: none;
            padding: 2rem 0;
        }
        
        .main-content.active {
            display: block;
        }
        
        /* KPIs */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }
        
        .kpi-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color);
            transition: transform 0.3s ease;
        }
        
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .kpi-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            background: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-size: 1.5rem;
        }
        
        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }
        
        .kpi-label {
            color: var(--gray-700);
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .kpi-trend {
            font-size: 0.875rem;
            font-weight: 500;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            background: var(--primary-light);
            color: var(--primary-color);
        }
        
        /* Filters */
        .filters-section {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .filter-group {
            margin-bottom: 1rem;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--gray-700);
        }
        
        .filter-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            background: white;
            color: var(--gray-900);
        }
        
        .filter-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        /* Charts */
        .charts-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }
        
        .chart-controls {
            display: flex;
            gap: 10px;
        }
        
        .chart-btn {
            padding: 0.5rem 1rem;
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .chart-btn:hover {
            background: var(--gray-200);
        }
        
        .chart-btn.primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        
        .chart-btn.primary:hover {
            background: var(--primary-dark);
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        
        /* Data Table */
        .data-section {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .data-table th {
            background: var(--gray-50);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 2px solid var(--gray-200);
            white-space: nowrap;
        }
        
        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            white-space: nowrap;
        }
        
        .data-table tr:hover {
            background: var(--gray-50);
        }
        
        /* Analysis Section */
        .analysis-section {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .indicator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .indicator-card {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 1.25rem;
        }
        
        .indicator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .indicator-name {
            font-weight: 600;
            color: var(--gray-900);
        }
        
        .indicator-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }
        
        .indicator-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .indicator-fill {
            height: 100%;
            border-radius: 4px;
        }
        
        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }
        
        .btn-secondary:hover {
            background: var(--gray-50);
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        /* Alerts */
        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .alert-success {
            background: var(--primary-light);
            color: var(--primary-dark);
            border: 1px solid var(--primary-color);
        }
        
        .alert-error {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fca5a5;
        }
        
        .alert-warning {
            background: #fef3c7;
            color: #d97706;
            border: 1px solid #fbbf24;
        }
        
        .alert-info {
            background: #dbeafe;
            color: #1d4ed8;
            border: 1px solid #93c5fd;
        }
        
        /* Footer */
        .footer {
            background: var(--gray-900);
            color: white;
            padding: 2rem 0;
            margin-top: 3rem;
        }
        
        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .footer-links {
            display: flex;
            gap: 1.5rem;
        }
        
        .footer-links a {
            color: var(--gray-300);
            text-decoration: none;
            transition: color 0.2s ease;
        }
        
        .footer-links a:hover {
            color: white;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-controls {
                flex-wrap: wrap;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .auth-section {
                width: 100%;
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-wrapper {
                height: 250px;
            }
        }
        
        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--gray-700);
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-200);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Instructions */
        .instructions {
            background: var(--primary-light);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-left: 4px solid var(--primary-color);
        }
        
        .instructions h3 {
            color: var(--primary-dark);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .instructions-list {
            list-style: none;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .instructions-list li {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 0.5rem 0;
        }
        
        .instructions-list i {
            color: var(--primary-color);
            margin-top: 3px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-seedling"></i>
                    <h1>Monitoreo <span>Caña</span></h1>
                </div>
                <div class="auth-section">
                    <button id="loginBtn" class="btn btn-secondary">
                        <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
                    </button>
                    <button id="registerBtn" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> Registrarse
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Login Form -->
    <div class="container">
        <div id="loginForm" class="auth-form">
            <h2 style="margin-bottom: 1.5rem; color: var(--gray-900);">Iniciar Sesión</h2>
            <div id="loginAlert" class="alert" style="display: none;"></div>
            <div class="filter-group">
                <label for="loginEmail">Correo Electrónico</label>
                <input type="email" id="loginEmail" class="filter-control" placeholder="tu@email.com">
            </div>
            <div class="filter-group">
                <label for="loginPassword">Contraseña</label>
                <input type="password" id="loginPassword" class="filter-control" placeholder="••••••••">
            </div>
            <button id="submitLogin" class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;">
                <i class="fas fa-sign-in-alt"></i> Ingresar
            </button>
            <div style="text-align: center; margin-top: 1rem;">
                <a href="#" id="showRegister" style="color: var(--primary-color); text-decoration: none;">
                    ¿No tienes cuenta? Regístrate aquí
                </a>
            </div>
        </div>

        <!-- Register Form -->
        <div id="registerForm" class="auth-form">
            <h2 style="margin-bottom: 1.5rem; color: var(--gray-900);">Crear Cuenta</h2>
            <div id="registerAlert" class="alert" style="display: none;"></div>
            <div class="filter-group">
                <label for="registerEmail">Correo Electrónico</label>
                <input type="email" id="registerEmail" class="filter-control" placeholder="tu@email.com">
            </div>
            <div class="filter-group">
                <label for="registerPassword">Contraseña</label>
                <input type="password" id="registerPassword" class="filter-control" placeholder="••••••••">
            </div>
            <div class="filter-group">
                <label for="registerConfirm">Confirmar Contraseña</label>
                <input type="password" id="registerConfirm" class="filter-control" placeholder="••••••••">
            </div>
            <button id="submitRegister" class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;">
                <i class="fas fa-user-plus"></i> Registrar Cuenta
            </button>
            <div style="text-align: center; margin-top: 1rem;">
                <a href="#" id="showLogin" style="color: var(--primary-color); text-decoration: none;">
                    ¿Ya tienes cuenta? Inicia sesión aquí
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content (visible después del login) -->
    <div id="mainContent" class="main-content">
        <div class="container">
            <!-- Instrucciones -->
            <div class="instructions">
                <h3><i class="fas fa-info-circle"></i> Instrucciones de Operación</h3>
                <ul class="instructions-list">
                    <li><i class="fas fa-filter"></i> <strong>Filtros:</strong> Utiliza los controles superiores para filtrar datos por ingenio, zona, grupo o supervisor.</li>
                    <li><i class="fas fa-chart-line"></i> <strong>Gráficos:</strong> Los gráficos se actualizan automáticamente según los filtros aplicados.</li>
                    <li><i class="fas fa-download"></i> <strong>Exportar:</strong> Descarga gráficos en PNG/SVG o genera un informe PDF completo.</li>
                    <li><i class="fas fa-table"></i> <strong>Tabla:</strong> Revisa todos los datos filtrados en la tabla inferior.</li>
                </ul>
            </div>

            <!-- KPIs -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <span class="kpi-trend" id="samplesTrend">Total</span>
                    </div>
                    <div class="kpi-value" id="totalSamples">0</div>
                    <div class="kpi-label">Muestras Totales</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="fas fa-trash"></i>
                        </div>
                        <span class="kpi-trend" id="impuritiesTrend">0%</span>
                    </div>
                    <div class="kpi-value" id="impuritiesAvg">0%</div>
                    <div class="kpi-label">Impurezas Totales</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="fas fa-ruler-vertical"></i>
                        </div>
                        <span class="kpi-trend" id="heightTrend">0cm</span>
                    </div>
                    <div class="kpi-value" id="cutHeightAvg">0cm</div>
                    <div class="kpi-label">Altura de Corte Promedio</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="fas fa-band-aid"></i>
                        </div>
                        <span class="kpi-trend" id="bandsTrend">0</span>
                    </div>
                    <div class="kpi-value" id="bandsUsageAvg">0</div>
                    <div class="kpi-label">Uso de Bandas Promedio</div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="filters-section">
                <h3 style="margin-bottom: 1.5rem; color: var(--gray-900);">Filtros de Datos</h3>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label for="filterIngenio"><i class="fas fa-industry"></i> Ingenio</label>
                        <select id="filterIngenio" class="filter-control">
                            <option value="Todos">Todos los Ingenios</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterZona"><i class="fas fa-map-marker-alt"></i> Zona</label>
                        <select id="filterZona" class="filter-control">
                            <option value="Todos">Todas las Zonas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterGrupo"><i class="fas fa-users"></i> Grupo de Cosecha</label>
                        <select id="filterGrupo" class="filter-control">
                            <option value="Todos">Todos los Grupos</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterSupervisor"><i class="fas fa-user-tie"></i> Supervisor de Cosecha</label>
                        <select id="filterSupervisor" class="filter-control">
                            <option value="Todos">Todos los Supervisores</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterIndicator"><i class="fas fa-chart-bar"></i> Indicador Principal</label>
                        <select id="filterIndicator" class="filter-control">
                            <option value="impurezas">Impurezas Totales</option>
                            <option value="altura">Altura de Corte</option>
                            <option value="pegada">Pegada de Corte</option>
                            <option value="bandas">Uso de Bandas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterTime"><i class="fas fa-calendar-alt"></i> Periodo</label>
                        <select id="filterTime" class="filter-control">
                            <option value="dia">Por Día</option>
                            <option value="semana">Por Semana</option>
                            <option value="mes">Por Mes</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button id="applyFilters" class="btn btn-primary">
                        <i class="fas fa-filter"></i> Aplicar Filtros
                    </button>
                    <button id="resetFilters" class="btn btn-secondary">
                        <i class="fas fa-redo"></i> Restablecer
                    </button>
                    <button id="generateReport" class="btn btn-primary">
                        <i class="fas fa-file-pdf"></i> Generar Informe PDF
                    </button>
                </div>
            </div>

            <!-- Gráficos Principales -->
            <div class="charts-section">
                <!-- Gráfico de Líneas -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title" id="lineChartTitle">Tendencia de Indicadores</h3>
                        <div class="chart-controls">
                            <button class="chart-btn" id="toggleLabels">
                                <i class="fas fa-tag"></i> Etiquetas
                            </button>
                            <button class="chart-btn" id="downloadLinePNG">
                                <i class="fas fa-download"></i> PNG
                            </button>
                            <button class="chart-btn" id="downloadLineSVG">
                                <i class="fas fa-download"></i> SVG
                            </button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="lineChart"></canvas>
                    </div>
                </div>

                <!-- Gráfico de Barras -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Resumen por Zona</h3>
                        <div class="chart-controls">
                            <button class="chart-btn" id="downloadBarPNG">
                                <i class="fas fa-download"></i> PNG
                            </button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Comparación -->
            <div class="chart-container" style="margin-bottom: 2rem;">
                <div class="chart-header">
                    <h3 class="chart-title">Comparación de Múltiples Indicadores</h3>
                    <div class="chart-controls">
                        <button class="chart-btn" id="toggleComparison">
                            <i class="fas fa-exchange-alt"></i> Alternar Vista
                        </button>
                    </div>
                </div>
                <div style="margin-bottom: 1rem;">
                    <div class="filter-group">
                        <label><i class="fas fa-layer-group"></i> Seleccionar Indicadores para Comparar:</label>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" class="comparisonIndicator" value="impurezas" checked>
                                Impurezas
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" class="comparisonIndicator" value="altura">
                                Altura Corte
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" class="comparisonIndicator" value="pegada">
                                Pegada Corte
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" class="comparisonIndicator" value="bandas">
                                Uso Bandas
                            </label>
                        </div>
                    </div>
                </div>
                <div class="chart-wrapper" style="height: 350px;">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>

            <!-- Análisis por Indicadores -->
            <div class="analysis-section">
                <div class="chart-header">
                    <h3 class="chart-title">Análisis Detallado por Indicador</h3>
                    <div class="chart-controls">
                        <select id="analysisGroupBy" class="filter-control" style="width: auto;">
                            <option value="zona">Agrupar por Zona</option>
                            <option value="grupo">Agrupar por Grupo</option>
                            <option value="supervisor">Agrupar por Supervisor</option>
                            <option value="ingenio">Agrupar por Ingenio</option>
                        </select>
                    </div>
                </div>
                <div class="indicator-grid" id="indicatorAnalysis">
                    <!-- Se llena dinámicamente con JavaScript -->
                </div>
            </div>

            <!-- Tabla de Datos -->
            <div class="data-section">
                <div class="chart-header">
                    <h3 class="chart-title">Datos Completos</h3>
                    <div class="chart-controls">
                        <button id="downloadData" class="chart-btn primary">
                            <i class="fas fa-download"></i> Descargar CSV
                        </button>
                    </div>
                </div>
                <div class="loading" id="tableLoading">
                    <div class="loading-spinner"></div>
                    <p>Cargando datos...</p>
                </div>
                <div id="dataTableContainer" style="display: none;">
                    <table class="data-table" id="dataTable">
                        <thead>
                            <tr>
                                <th>Ingenio</th>
                                <th>No. Muestra</th>
                                <th>Fecha</th>
                                <th>Zona</th>
                                <th>Grupo</th>
                                <th>Supervisor</th>
                                <th>% Impurezas</th>
                                <th>Altura (cm)</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Datos se insertan aquí -->
                        </tbody>
                    </table>
                </div>
                <div id="tableInfo" style="margin-top: 1rem; color: var(--gray-700); font-size: 0.875rem;">
                    Mostrando <span id="shownCount">0</span> de <span id="totalCount">0</span> registros
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div>
                    <p style="color: var(--gray-300);">© 2025 Sistema de Monitoreo de Caña de Azúcar</p>
                    <p style="color: var(--gray-400); font-size: 0.875rem; margin-top: 0.5rem;">
                        Conectado a Google Sheets | GitHub Pages
                    </p>
                </div>
                <div class="footer-links">
                    <a href="#"><i class="fas fa-question-circle"></i> Ayuda</a>
                    <a href="#"><i class="fas fa-envelope"></i> Contacto</a>
                    <a href="#"><i class="fas fa-shield-alt"></i> Privacidad</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
    // Configuración global
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxXogeMr6tsb_8h9Ql6T69Wpf04IhKi_GL7gB54PVblGMxzPFpCUkSOfJlepOEKe-Nb/exec';
    let currentUser = null;
    let allData = [];
    let filteredData = [];
    let charts = {};
    let filterOptions = {};

    // Inicialización
    document.addEventListener('DOMContentLoaded', function() {
        initializeAuth();
        // Los gráficos y filtros se inicializan después del login
    });

    // ==================== SISTEMA DE AUTENTICACIÓN ====================
    function initializeAuth() {
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const showRegister = document.getElementById('showRegister');
        const showLogin = document.getElementById('showLogin');
        const submitLogin = document.getElementById('submitLogin');
        const submitRegister = document.getElementById('submitRegister');

        // Mostrar formulario de login
        loginBtn.addEventListener('click', () => {
            loginForm.classList.add('active');
            registerForm.classList.remove('active');
        });

        // Mostrar formulario de registro
        registerBtn.addEventListener('click', () => {
            registerForm.classList.add('active');
            loginForm.classList.remove('active');
        });

        // Cambiar a registro
        showRegister.addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.classList.add('active');
            loginForm.classList.remove('active');
        });

        // Cambiar a login
        showLogin.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('active');
            registerForm.classList.remove('active');
        });

        // Enviar login
        submitLogin.addEventListener('click', handleLogin);

        // Enviar registro - SOLO ESTE MANEJADOR, NO HAY OTRO
        submitRegister.addEventListener('click', handleRegister);
    }

    async function handleLogin() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const alertDiv = document.getElementById('loginAlert');

        if (!email || !password) {
            showAlert(alertDiv, 'Por favor completa todos los campos', 'error');
            return;
        }

        showAlert(alertDiv, 'Verificando credenciales...', 'info');
        console.log('Iniciando login para:', email);

        try {
            const params = new URLSearchParams();
            params.append('action', 'login');
            params.append('email', email);
            params.append('password', password);

            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                },
                body: params
            });

            console.log('Respuesta recibida. Status:', response.status);

            // Verificar si la respuesta es JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('Respuesta no es JSON:', text.substring(0, 500));
                throw new Error(`El servidor no respondió con JSON: ${text.substring(0, 100)}`);
            }

            const data = await response.json();
            console.log('Datos de respuesta login:', data);

            if (data.success) {
                currentUser = data.user;
                showAlert(alertDiv, '¡Login exitoso!', 'success');
                
                // Ocultar formularios, mostrar contenido principal
                document.getElementById('loginForm').classList.remove('active');
                document.getElementById('registerForm').classList.remove('active');
                document.getElementById('mainContent').classList.add('active');
                
                // Cargar datos
                loadInitialData();
            } else {
                showAlert(alertDiv, data.message || 'Error en el login', 'error');
            }
        } catch (error) {
            console.error('Error en login:', error);
            let errorMessage = 'Error de conexión: ';
            
            if (error.name === 'AbortError') {
                errorMessage += 'Tiempo de espera agotado';
            } else if (error.message.includes('Failed to fetch')) {
                errorMessage += 'No se pudo conectar con el servidor. Verifica:<br>';
                errorMessage += '1. Que la URL del GAS sea correcta<br>';
                errorMessage += '2. Que el GAS esté desplegado como aplicación web<br>';
                errorMessage += '3. Que tengas conexión a internet';
            } else {
                errorMessage += error.message;
            }
            
            showAlert(alertDiv, errorMessage, 'error');
        }
    }

    async function handleRegister() {
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;
        const confirm = document.getElementById('registerConfirm').value;
        const alertDiv = document.getElementById('registerAlert');

        if (!email || !password || !confirm) {
            showAlert(alertDiv, 'Por favor completa todos los campos', 'error');
            return;
        }

        if (password !== confirm) {
            showAlert(alertDiv, 'Las contraseñas no coinciden', 'error');
            return;
        }

        if (password.length < 6) {
            showAlert(alertDiv, 'La contraseña debe tener al menos 6 caracteres', 'error');
            return;
        }

        showAlert(alertDiv, 'Creando cuenta...', 'info');
        console.log('Enviando registro para:', email);

        try {
            const params = new URLSearchParams();
            params.append('action', 'register');
            params.append('email', email);
            params.append('password', password);

            // Configurar timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000);

            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                },
                body: params,
                signal: controller.signal
            });

            clearTimeout(timeoutId);
            console.log('Respuesta recibida. Status:', response.status);

            // Verificar si la respuesta es JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('Respuesta no es JSON:', text.substring(0, 500));
                throw new Error(`El servidor no respondió con JSON: ${text.substring(0, 100)}`);
            }

            const data = await response.json();
            console.log('Datos de respuesta registro:', data);

            if (data.success) {
                showAlert(alertDiv, '¡Cuenta creada exitosamente! Ahora puedes iniciar sesión.', 'success');
                
                // Cambiar a formulario de login
                setTimeout(() => {
                    document.getElementById('registerForm').classList.remove('active');
                    document.getElementById('loginForm').classList.add('active');
                    document.getElementById('loginEmail').value = email;
                    document.getElementById('loginPassword').value = '';
                    document.getElementById('registerEmail').value = '';
                    document.getElementById('registerPassword').value = '';
                    document.getElementById('registerConfirm').value = '';
                }, 2000);
            } else {
                showAlert(alertDiv, `Error: ${data.message || 'Error desconocido'}`, 'error');
            }
        } catch (error) {
            console.error('Error en registro:', error);
            let errorMessage = 'Error de conexión: ';
            
            if (error.name === 'AbortError') {
                errorMessage += 'Tiempo de espera agotado (30 segundos)';
            } else if (error.message.includes('Failed to fetch')) {
                errorMessage += 'No se pudo conectar con el servidor. Posibles causas:<br>';
                errorMessage += '1. URL del GAS incorrecta<br>';
                errorMessage += '2. GAS no desplegado correctamente<br>';
                errorMessage += '3. Bloqueo de CORS (usa la solución de abajo)';
            } else {
                errorMessage += error.message;
            }
            
            showAlert(alertDiv, errorMessage, 'error');
        }
    }

    function showAlert(element, message, type) {
        element.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            ${message}
        `;
        element.className = `alert alert-${type}`;
        element.style.display = 'flex';
    }

    // ==================== CARGA DE DATOS Y FILTROS ====================
    async function loadInitialData() {
        try {
            console.log('Cargando datos iniciales...');
            const response = await fetch(`${GAS_URL}?action=getInitialData&timestamp=${Date.now()}`);
            const data = await response.json();

            if (data.success) {
                filterOptions = data.filterOptions;
                allData = data.data || [];
                filteredData = [...allData];
                
                updateKPI(data.kpis);
                updateFilterOptions();
                initializeCharts();
                updateCharts();
                updateDataTable();
                console.log('Datos cargados exitosamente');
            }
        } catch (error) {
            console.error('Error cargando datos iniciales:', error);
            showAlert(document.getElementById('loginAlert'), 'Error cargando datos: ' + error.message, 'error');
        }
    }

    function updateKPI(kpis) {
        document.getElementById('totalSamples').textContent = kpis.muestrasTotales.toLocaleString();
        document.getElementById('impuritiesAvg').textContent = kpis.impurezasPromedio.toFixed(2) + '%';
        document.getElementById('cutHeightAvg').textContent = kpis.alturaPromedio.toFixed(1) + 'cm';
        document.getElementById('bandsUsageAvg').textContent = kpis.bandasPromedio.toFixed(1);
        
        // Actualizar tendencias
        updateTrendColors('impuritiesTrend', kpis.impurezasPromedio, 2, 5);
        updateTrendColors('heightTrend', kpis.alturaPromedio, 15, 20);
    }

    function updateTrendColors(elementId, value, warningThreshold, dangerThreshold) {
        const element = document.getElementById(elementId);
        if (value <= warningThreshold) {
            element.style.background = '#d1fae5';
            element.style.color = '#059669';
        } else if (value <= dangerThreshold) {
            element.style.background = '#fef3c7';
            element.style.color = '#d97706';
        } else {
            element.style.background = '#fee2e2';
            element.style.color = '#dc2626';
        }
    }

    function updateFilterOptions() {
        updateSelectOptions('filterIngenio', ['Todos', ...filterOptions.ingenios || []]);
        updateSelectOptions('filterZona', ['Todos', ...filterOptions.zonas || []]);
        updateSelectOptions('filterGrupo', ['Todos', ...filterOptions.grupos || []]);
        updateSelectOptions('filterSupervisor', ['Todos', ...filterOptions.supervisores || []]);
        
        // Configurar eventos de filtro
        document.getElementById('applyFilters').addEventListener('click', applyFilters);
        document.getElementById('resetFilters').addEventListener('click', resetFilters);
        document.getElementById('generateReport').addEventListener('click', generatePDFReport);
    }

    function updateSelectOptions(selectId, options) {
        const select = document.getElementById(selectId);
        select.innerHTML = '';
        options.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option;
            opt.textContent = option;
            select.appendChild(opt);
        });
    }

    async function applyFilters() {
        const filters = {
            ingenio: document.getElementById('filterIngenio').value,
            zona: document.getElementById('filterZona').value,
            grupo: document.getElementById('filterGrupo').value,
            supervisor: document.getElementById('filterSupervisor').value
        };

        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    action: 'filterData',
                    ...filters
                })
            });

            const data = await response.json();

            if (data.success) {
                filteredData = data.data;
                updateCharts();
                updateDataTable();
                
                // Recalcular KPIs para datos filtrados
                const kpis = calculateFilteredKPIs();
                updateKPI(kpis);
            }
        } catch (error) {
            console.error('Error aplicando filtros:', error);
        }
    }

    function calculateFilteredKPIs() {
        if (filteredData.length === 0) {
            return {
                muestrasTotales: 0,
                impurezasPromedio: 0,
                alturaPromedio: 0,
                bandasPromedio: 0,
                pegadaPromedio: 0,
                puntaBasuraPromedio: 0
            };
        }

        let impurezasSum = 0;
        let alturaSum = 0;
        let bandasSum = 0;
        let pegadaSum = 0;
        let puntaBasuraSum = 0;

        filteredData.forEach(row => {
            // Sumar impurezas (ejemplo simplificado)
            impurezasSum += (parseFloat(row['% Picada']) || 0) + 
                           (parseFloat(row['% Mamones']) || 0);
            alturaSum += parseFloat(row['Altura del corte (cm)']) || 0;
            bandasSum += parseInt(row['Uso de bandas']) || 0;
            pegadaSum += parseInt(row['Pegada de corte (n°)']) || 0;
            puntaBasuraSum += parseFloat(row['Punta en basura (Kg)']) || 0;
        });

        return {
            muestrasTotales: filteredData.length,
            impurezasPromedio: impurezasSum / filteredData.length / 2,
            alturaPromedio: alturaSum / filteredData.length,
            bandasPromedio: bandasSum / filteredData.length,
            pegadaPromedio: pegadaSum / filteredData.length,
            puntaBasuraPromedio: puntaBasuraSum / filteredData.length
        };
    }

    function resetFilters() {
        document.getElementById('filterIngenio').value = 'Todos';
        document.getElementById('filterZona').value = 'Todos';
        document.getElementById('filterGrupo').value = 'Todos';
        document.getElementById('filterSupervisor').value = 'Todos';
        document.getElementById('filterIndicator').value = 'impurezas';
        document.getElementById('filterTime').value = 'dia';
        
        filteredData = [...allData];
        updateCharts();
        updateDataTable();
        
        // Restaurar KPIs originales
        if (allData.length > 0) {
            const kpis = calculateFilteredKPIs();
            updateKPI(kpis);
        }
    }

    // ==================== GRÁFICOS ====================
    function initializeCharts() {
        // Gráfico de líneas
        const lineCtx = document.getElementById('lineChart').getContext('2d');
        charts.line = new Chart(lineCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Indicador',
                    data: [],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    x: { grid: { display: true } },
                    y: { 
                        grid: { display: true },
                        beginAtZero: true
                    }
                }
            }
        });

        // Gráfico de barras
        const barCtx = document.getElementById('barChart').getContext('2d');
        charts.bar = new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Valor',
                    data: [],
                    backgroundColor: [],
                    borderColor: [],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { beginAtZero: true }
                }
            }
        });

        // Gráfico de comparación
        const compCtx = document.getElementById('comparisonChart').getContext('2d');
        charts.comparison = new Chart(compCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    x: { grid: { display: true } },
                    y: { beginAtZero: true }
                }
            }
        });

        // Configurar controles de gráficos
        setupChartControls();
    }

    function setupChartControls() {
        // Descargar gráficos
        document.getElementById('downloadLinePNG').addEventListener('click', () => {
            downloadChart(charts.line, 'line-chart.png');
        });
        
        document.getElementById('downloadLineSVG').addEventListener('click', () => {
            downloadChart(charts.line, 'line-chart.svg', 'svg');
        });
        
        document.getElementById('downloadBarPNG').addEventListener('click', () => {
            downloadChart(charts.bar, 'bar-chart.png');
        });

        // Alternar etiquetas
        document.getElementById('toggleLabels').addEventListener('click', function() {
            const show = charts.line.options.plugins.datalabels = 
                !charts.line.options.plugins.datalabels;
            charts.line.update();
            this.innerHTML = show ? 
                '<i class="fas fa-tag"></i> Ocultar Etiquetas' : 
                '<i class="fas fa-tag"></i> Mostrar Etiquetas';
        });

        // Actualizar gráfico de comparación
        document.querySelectorAll('.comparisonIndicator').forEach(checkbox => {
            checkbox.addEventListener('change', updateComparisonChart);
        });
        
        document.getElementById('toggleComparison').addEventListener('click', function() {
            const isBar = charts.comparison.config.type === 'bar';
            charts.comparison.config.type = isBar ? 'line' : 'bar';
            charts.comparison.update();
            this.innerHTML = isBar ? 
                '<i class="fas fa-chart-line"></i> Ver Líneas' : 
                '<i class="fas fa-chart-bar"></i> Ver Barras';
        });

        // Análisis por grupo
        document.getElementById('analysisGroupBy').addEventListener('change', updateIndicatorAnalysis);
    }

    function downloadChart(chart, filename, format = 'png') {
        const link = document.createElement('a');
        link.download = filename;
        link.href = chart.toBase64Image(format === 'svg' ? 'image/svg+xml' : 'image/png');
        link.click();
    }

    function updateCharts() {
        updateLineChart();
        updateBarChart();
        updateComparisonChart();
        updateIndicatorAnalysis();
    }

    function updateLineChart() {
        if (filteredData.length === 0) return;

        const indicator = document.getElementById('filterIndicator').value;
        const timePeriod = document.getElementById('filterTime').value;
        
        // Agrupar datos por período de tiempo
        const groupedData = groupDataByTime(filteredData, timePeriod);
        
        // Preparar datos para el gráfico
        const labels = Object.keys(groupedData);
        const values = Object.values(groupedData).map(group => {
            return calculateGroupAverage(group, indicator);
        });

        // Actualizar gráfico
        charts.line.data.labels = labels;
        charts.line.data.datasets[0].data = values;
        charts.line.data.datasets[0].label = getIndicatorLabel(indicator);
        charts.line.update();
        
        // Actualizar título
        document.getElementById('lineChartTitle').textContent = 
            `Tendencia de ${getIndicatorLabel(indicator)} por ${timePeriod === 'dia' ? 'Día' : timePeriod === 'semana' ? 'Semana' : 'Mes'}`;
    }

    function groupDataByTime(data, period) {
        const groups = {};
        
        data.forEach(row => {
            const date = new Date(row.Fecha);
            let key;
            
            switch(period) {
                case 'semana':
                    const week = getWeekNumber(date);
                    key = `Sem ${week}`;
                    break;
                case 'mes':
                    key = date.toLocaleDateString('es-ES', { month: 'short' });
                    break;
                default: // día
                    key = date.toLocaleDateString('es-ES');
            }
            
            if (!groups[key]) groups[key] = [];
            groups[key].push(row);
        });
        
        return groups;
    }

    function getWeekNumber(date) {
        const firstDay = new Date(date.getFullYear(), 0, 1);
        const days = Math.floor((date - firstDay) / (24 * 60 * 60 * 1000));
        return Math.ceil((days + firstDay.getDay() + 1) / 7);
    }

    function calculateGroupAverage(group, indicator) {
        if (group.length === 0) return 0;
        
        let sum = 0;
        group.forEach(row => {
            switch(indicator) {
                case 'impurezas':
                    sum += (parseFloat(row['% Picada']) || 0) + 
                           (parseFloat(row['% Mamones']) || 0);
                    break;
                case 'altura':
                    sum += parseFloat(row['Altura del corte (cm)']) || 0;
                    break;
                case 'pegada':
                    sum += parseInt(row['Pegada de corte (n°)']) || 0;
                    break;
                case 'bandas':
                    sum += parseInt(row['Uso de bandas']) || 0;
                    break;
            }
        });
        
        return indicator === 'impurezas' ? sum / group.length / 2 : sum / group.length;
    }

    function getIndicatorLabel(indicator) {
        const labels = {
            impurezas: 'Impurezas Totales (%)',
            altura: 'Altura de Corte (cm)',
            pegada: 'Pegada de Corte (n°)',
            bandas: 'Uso de Bandas'
        };
        return labels[indicator] || indicator;
    }

    function updateBarChart() {
        if (filteredData.length === 0) return;

        // Agrupar por zona
        const zonas = {};
        filteredData.forEach(row => {
            const zona = row.Zona || 'Sin Zona';
            if (!zonas[zona]) zonas[zona] = [];
            zonas[zona].push(row);
        });

        // Preparar datos
        const labels = Object.keys(zonas);
        const values = Object.values(zonas).map(group => group.length);
        
        // Colores semáforo basados en el promedio de impurezas
        const colors = Object.values(zonas).map(group => {
            const avgImpurity = calculateGroupAverage(group, 'impurezas');
            return getTrafficLightColor(avgImpurity, 2, 5);
        });

        // Actualizar gráfico
        charts.bar.data.labels = labels;
        charts.bar.data.datasets[0].data = values;
        charts.bar.data.datasets[0].backgroundColor = colors;
        charts.bar.data.datasets[0].borderColor = colors.map(c => c.replace('0.8', '1'));
        charts.bar.update();
    }

    function getTrafficLightColor(value, warning, danger) {
        if (value <= warning) {
            return 'rgba(16, 185, 129, 0.8)'; // Verde
        } else if (value <= danger) {
            return 'rgba(245, 158, 11, 0.8)'; // Amarillo
        } else {
            return 'rgba(239, 68, 68, 0.8)'; // Rojo
        }
    }

    function updateComparisonChart() {
        if (filteredData.length === 0) return;

        const selectedIndicators = Array.from(
            document.querySelectorAll('.comparisonIndicator:checked')
        ).map(cb => cb.value);

        if (selectedIndicators.length === 0) return;

        // Agrupar por zona
        const zonas = {};
        filteredData.forEach(row => {
            const zona = row.Zona || 'Sin Zona';
            if (!zonas[zona]) zonas[zona] = [];
            zonas[zona].push(row);
        });

        const labels = Object.keys(zonas);
        const datasets = selectedIndicators.map((indicator, index) => {
            const values = Object.values(zonas).map(group => 
                calculateGroupAverage(group, indicator)
            );
            
            return {
                label: getIndicatorLabel(indicator),
                data: values,
                backgroundColor: getIndicatorColor(indicator, index),
                borderColor: getIndicatorColor(indicator, index).replace('0.6', '1'),
                borderWidth: 1
            };
        });

        charts.comparison.data.labels = labels;
        charts.comparison.data.datasets = datasets;
        charts.comparison.update();
    }

    function getIndicatorColor(indicator, index) {
        const colors = [
            'rgba(16, 185, 129, 0.6)',  // Verde
            'rgba(59, 130, 246, 0.6)',  // Azul
            'rgba(245, 158, 11, 0.6)',  // Amarillo
            'rgba(139, 92, 246, 0.6)',  // Púrpura
            'rgba(239, 68, 68, 0.6)'    // Rojo
        ];
        return colors[index % colors.length];
    }

    function updateIndicatorAnalysis() {
        if (filteredData.length === 0) return;

        const groupBy = document.getElementById('analysisGroupBy').value;
        
        // Agrupar datos
        const groups = {};
        filteredData.forEach(row => {
            const key = row[getGroupByField(groupBy)] || `Sin ${groupBy}`;
            if (!groups[key]) groups[key] = [];
            groups[key].push(row);
        });

        // Calcular métricas para cada grupo
        const analysisHTML = Object.entries(groups).map(([groupName, groupData]) => {
            const metrics = calculateGroupMetrics(groupData);
            return createIndicatorCard(groupName, metrics, groupData.length);
        }).join('');

        document.getElementById('indicatorAnalysis').innerHTML = analysisHTML;
    }

    function getGroupByField(groupBy) {
        const fields = {
            zona: 'Zona',
            grupo: 'Grupo de cosecha',
            supervisor: 'Supervisor de cosecha',
            ingenio: 'Ingenio'
        };
        return fields[groupBy] || groupBy;
    }

    function calculateGroupMetrics(groupData) {
        if (groupData.length === 0) return {};

        let impurezas = 0;
        let altura = 0;
        let pegada = 0;
        let bandas = 0;

        groupData.forEach(row => {
            impurezas += (parseFloat(row['% Picada']) || 0) + 
                        (parseFloat(row['% Mamones']) || 0);
            altura += parseFloat(row['Altura del corte (cm)']) || 0;
            pegada += parseInt(row['Pegada de corte (n°)']) || 0;
            bandas += parseInt(row['Uso de bandas']) || 0;
        });

        const count = groupData.length;
        return {
            impurezas: impurezas / count / 2,
            altura: altura / count,
            pegada: pegada / count,
            bandas: bandas / count
        };
    }

    function createIndicatorCard(groupName, metrics, sampleCount) {
        const impurezasColor = getTrafficLightColor(metrics.impurezas, 2, 5);
        const alturaColor = getTrafficLightColor(20 - metrics.altura, 5, 10); // Invertido: más alto es mejor

        return `
            <div class="indicator-card">
                <div class="indicator-header">
                    <div class="indicator-name">${groupName}</div>
                    <div style="font-size: 0.875rem; color: var(--gray-600);">
                        ${sampleCount} muestras
                    </div>
                </div>
                <div class="indicator-value">${metrics.impurezas.toFixed(2)}%</div>
                <div class="indicator-bar">
                    <div class="indicator-fill" style="width: ${Math.min(metrics.impurezas * 10, 100)}%; background: ${impurezasColor};"></div>
                </div>
                <div style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 0.5rem;">
                    Impurezas Totales
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
                    <div>
                        <div style="font-size: 0.75rem; color: var(--gray-600);">Altura</div>
                        <div style="font-weight: 600;">${metrics.altura.toFixed(1)}cm</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: var(--gray-600);">Bandas</div>
                        <div style="font-weight: 600;">${metrics.bandas.toFixed(1)}</div>
                    </div>
                </div>
            </div>
        `;
    }

    // ==================== TABLA DE DATOS ====================
    function updateDataTable() {
        const tableBody = document.getElementById('tableBody');
        const tableLoading = document.getElementById('tableLoading');
        const tableContainer = document.getElementById('dataTableContainer');
        const shownCount = document.getElementById('shownCount');
        const totalCount = document.getElementById('totalCount');

        // Mostrar loading
        tableLoading.style.display = 'flex';
        tableContainer.style.display = 'none';

        // Limitar a 100 registros para rendimiento
        const displayData = filteredData.slice(0, 100);

        setTimeout(() => {
            // Generar filas de tabla
            const rows = displayData.map(row => `
                <tr>
                    <td>${row.Ingenio || ''}</td>
                    <td>${row['No. Muestra'] || ''}</td>
                    <td>${row.Fecha || ''}</td>
                    <td>${row.Zona || ''}</td>
                    <td>${row['Grupo de cosecha'] || ''}</td>
                    <td>${row['Supervisor de cosecha'] || ''}</td>
                    <td>${((parseFloat(row['% Picada']) || 0) + (parseFloat(row['% Mamones']) || 0)).toFixed(2)}%</td>
                    <td>${row['Altura del corte (cm)'] || ''}</td>
                    <td>
                        <span style="
                            display: inline-block;
                            padding: 0.25rem 0.5rem;
                            border-radius: 4px;
                            font-size: 0.75rem;
                            font-weight: 500;
                            background: ${row['Conformidad de calidad de cosecha'] === 'conforme' ? 
                                '#d1fae5' : '#fee2e2'};
                            color: ${row['Conformidad de calidad de cosecha'] === 'conforme' ? 
                                '#059669' : '#dc2626'};
                        ">
                            ${row['Conformidad de calidad de cosecha'] || 'No conforme'}
                        </span>
                    </td>
                </tr>
            `).join('');

            tableBody.innerHTML = rows;
            shownCount.textContent = displayData.length;
            totalCount.textContent = filteredData.length;

            // Ocultar loading, mostrar tabla
            tableLoading.style.display = 'none';
            tableContainer.style.display = 'block';
        }, 500);

        // Configurar botón de descarga
        document.getElementById('downloadData').addEventListener('click', downloadDataCSV);
    }

    function downloadDataCSV() {
        if (filteredData.length === 0) return;

        // Crear cabeceras CSV
        const headers = Object.keys(filteredData[0]);
        const csvRows = [
            headers.join(','),
            ...filteredData.map(row => 
                headers.map(header => {
                    const value = row[header] || '';
                    return `"${value.toString().replace(/"/g, '""')}"`;
                }).join(',')
            )
        ];

        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `datos-cana-${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
    }

    // ==================== GENERAR INFORME PDF ====================
    async function generatePDFReport() {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Título
            doc.setFontSize(20);
            doc.setTextColor(16, 185, 129);
            doc.text('Informe de Monitoreo de Caña', 105, 20, { align: 'center' });
            
            // Metadatos
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generado: ${new Date().toLocaleDateString('es-ES')}`, 20, 30);
            doc.text(`Usuario: ${currentUser?.email || 'No autenticado'}`, 20, 35);
            doc.text(`Muestras: ${filteredData.length}`, 20, 40);
            
            // KPIs
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text('Resumen de Indicadores', 20, 55);
            
            const kpis = calculateFilteredKPIs();
            const kpiText = [
                `Muestras Totales: ${kpis.muestrasTotales}`,
                `Impurezas Promedio: ${kpis.impurezasPromedio.toFixed(2)}%`,
                `Altura de Corte Promedio: ${kpis.alturaPromedio.toFixed(1)}cm`,
                `Uso de Bandas Promedio: ${kpis.bandasPromedio.toFixed(1)}`
            ];
            
            doc.setFontSize(11);
            kpiText.forEach((text, i) => {
                doc.text(text, 20, 65 + (i * 7));
            });
            
            // Filtros aplicados
            doc.setFontSize(14);
            doc.text('Filtros Aplicados', 20, 100);
            doc.setFontSize(11);
            
            const filters = {
                'Ingenio': document.getElementById('filterIngenio').value,
                'Zona': document.getElementById('filterZona').value,
                'Grupo': document.getElementById('filterGrupo').value,
                'Supervisor': document.getElementById('filterSupervisor').value
            };
            
            Object.entries(filters).forEach(([key, value], i) => {
                doc.text(`${key}: ${value}`, 20, 110 + (i * 7));
            });
            
            // Capturar gráfico principal
            const chartCanvas = document.getElementById('lineChart');
            if (chartCanvas) {
                const chartImage = await html2canvas(chartCanvas);
                const imgData = chartImage.toDataURL('image/png');
                doc.addPage();
                doc.text('Gráfico de Tendencia', 20, 20);
                doc.addImage(imgData, 'PNG', 20, 30, 170, 80);
            }
            
            // Guardar PDF
            doc.save(`informe-cana-${new Date().toISOString().split('T')[0]}.pdf`);
            
        } catch (error) {
            console.error('Error generando PDF:', error);
            alert('Error al generar el informe PDF. Por favor, intente nuevamente.');
        }
    }
</script>
</body>
</html>
