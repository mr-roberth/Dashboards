<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Análisis de Calidad de Cosecha</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #2e7d32;
            --primary-dark: #1b5e20;
            --primary-light: #4caf50;
            --secondary-color: #f5f5f5;
            --text-dark: #333;
            --text-light: #666;
            --white: #ffffff;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: var(--text-dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            color: white;
            padding: 15px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-img {
            height: 50px;
            width: auto;
        }
        
        .logo-text h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .logo-text p {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: var(--border-radius);
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary-light);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: #e0e0e0;
            color: var(--text-dark);
        }
        
        .btn-secondary:hover {
            background-color: #d0d0d0;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.9rem;
        }
        
        /* Auth Screens */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }
        
        .auth-box {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 40px;
            width: 100%;
            max-width: 500px;
        }
        
        .auth-logo {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .auth-logo img {
            height: 80px;
            width: auto;
            margin-bottom: 15px;
        }
        
        .auth-title {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-dark);
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .form-control {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        /* Dashboard */
        .dashboard-container {
            display: none;
        }
        
        /* KPI Cards */
        .kpi-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: var(--primary-dark);
            font-size: 1.4rem;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .kpi-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            transition: transform 0.3s ease;
        }
        
        .kpi-card:hover {
            transform: translateY(-5px);
        }
        
        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .kpi-icon {
            font-size: 1.8rem;
        }
        
        .kpi-title {
            font-size: 0.9rem;
            color: var(--text-light);
            font-weight: 600;
        }
        
        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .kpi-subtitle {
            font-size: 0.8rem;
            color: var(--text-light);
        }
        
        /* Filters Section */
        .filters-section {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .filter-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1024px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }
        
        .chart-container {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            height: 400px;
            position: relative;
        }
        
        .chart-wrapper {
            height: 320px;
            width: 100%;
            position: relative;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* Comparative Section */
        .comparative-section {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            height: 500px;
        }
        
        .indicators-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: var(--border-radius);
        }
        
        .indicator-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Data Table */
        .data-section {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .data-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .data-table tr:hover {
            background-color: #f9f9f9;
        }
        
        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .metric-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
        }
        
        /* Footer */
        footer {
            background-color: var(--primary-dark);
            color: white;
            padding: 30px 0;
            margin-top: 50px;
        }
        
        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Alerts */
        .alert {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 50px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 600;
            color: var(--text-light);
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <img src="https://www.gporres.com.mx/PFER/Images/Porres400x129.png" alt="Logo Porres" class="logo-img">
                    <div class="logo-text">
                        <h1>Sistema de Análisis de Calidad de Cosecha</h1>
                        <p>Monitoreo y análisis de indicadores de calidad</p>
                    </div>
                </div>
                <div class="user-info" id="userInfo">
                    <span id="userName">Invitado</span>
                    <button class="btn btn-secondary" id="logoutBtn" style="display: none;">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="auth-container">
            <div class="auth-box">
                <div class="auth-logo">
                    <img src="https://www.gporres.com.mx/PFER/Images/Porres400x129.png" alt="Logo Porres">
                </div>
                <h2 class="auth-title"><i class="fas fa-sign-in-alt"></i> Iniciar Sesión</h2>
                <div id="loginAlert"></div>
                <form id="loginForm" class="auth-form">
                    <div class="form-group">
                        <label for="loginUsername">Usuario</label>
                        <input type="text" id="loginUsername" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Contraseña</label>
                        <input type="password" id="loginPassword" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
                    </button>
                </form>
                <div class="auth-links" style="text-align: center; margin-top: 20px;">
                    <p>¿No tienes cuenta? <a href="#" id="showRegister">Regístrate aquí</a></p>
                </div>
            </div>
        </div>
        
        <!-- Register Screen -->
        <div id="registerScreen" class="auth-container" style="display: none;">
            <div class="auth-box">
                <div class="auth-logo">
                    <img src="https://www.gporres.com.mx/PFER/Images/Porres400x129.png" alt="Logo Porres">
                </div>
                <h2 class="auth-title"><i class="fas fa-user-plus"></i> Crear Cuenta</h2>
                <div id="registerAlert"></div>
                <form id="registerForm" class="auth-form">
                    <div class="form-group">
                        <label for="registerName">Nombre Completo</label>
                        <input type="text" id="registerName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="registerUsername">Usuario</label>
                        <input type="text" id="registerUsername" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Contraseña</label>
                        <input type="password" id="registerPassword" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="registerConfirmPassword">Confirmar Contraseña</label>
                        <input type="password" id="registerConfirmPassword" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> Registrarse
                    </button>
                </form>
                <div class="auth-links" style="text-align: center; margin-top: 20px;">
                    <p>¿Ya tienes cuenta? <a href="#" id="showLogin">Inicia sesión aquí</a></p>
                </div>
            </div>
        </div>
        
        <!-- Dashboard -->
        <div id="dashboard" class="dashboard-container">
            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" data-tab="dashboard-tab">
                    <i class="fas fa-dashboard"></i> Dashboard
                </div>
                <div class="tab" data-tab="analytics-tab">
                    <i class="fas fa-chart-bar"></i> Análisis Detallado
                </div>
                <div class="tab" data-tab="data-tab">
                    <i class="fas fa-table"></i> Datos Completos
                </div>
                <div class="tab" data-tab="reports-tab">
                    <i class="fas fa-file-pdf"></i> Reportes
                </div>
            </div>
            
            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <!-- KPI Section -->
                <section class="kpi-section">
                    <h2 class="section-title"><i class="fas fa-chart-line"></i> Indicadores Principales</h2>
                    <div class="kpi-grid" id="kpiGrid">
                        <!-- KPI cards will be dynamically generated -->
                    </div>
                </section>
                
                <!-- Filters Section -->
                <section class="filters-section">
                    <h2 class="section-title"><i class="fas fa-filter"></i> Filtros de Análisis</h2>
                    <div class="filters-grid" id="filtersGrid">
                        <!-- Filters will be dynamically generated -->
                    </div>
                    <div class="filter-actions">
                        <button class="btn btn-secondary" id="resetFilters">
                            <i class="fas fa-redo"></i> Limpiar Filtros
                        </button>
                        <button class="btn btn-primary" id="applyFilters">
                            <i class="fas fa-search"></i> Aplicar Filtros
                        </button>
                        <button class="btn btn-secondary" id="refreshData">
                            <i class="fas fa-sync-alt"></i> Actualizar Datos
                        </button>
                    </div>
                </section>
                
                <!-- Charts Section -->
                <section class="charts-section">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-line"></i> Tendencia de Indicadores</h3>
                            <div class="chart-controls">
                                <select id="chartIndicator" class="form-control" style="width: 200px;">
                                    <option value="impurezasTotales">Impurezas Totales</option>
                                    <option value="picada">% Picada</option>
                                    <option value="mamones">% Mamones</option>
                                    <option value="lalas">% Lalas</option>
                                    <option value="tallosSecos">% Tallos Secos</option>
                                    <option value="tallosDaniados">% Tallos Dañados</option>
                                    <option value="raices">% Raíces Adheridas</option>
                                    <option value="punta">% Punta</option>
                                    <option value="tierra">% Tierra</option>
                                    <option value="piedra">% Piedra</option>
                                    <option value="puntaBasura">Punta en Basura</option>
                                    <option value="alturaCorte">Altura de Corte</option>
                                    <option value="usoBandas">Uso de Bandas</option>
                                    <option value="pegadaCorte">Pegada de Corte</option>
                                </select>
                                <select id="chartGroupBy" class="form-control" style="width: 150px;">
                                    <option value="semana">Por Semana</option>
                                    <option value="dia">Por Día</option>
                                    <option value="mes">Por Mes</option>
                                </select>
                                <button class="btn btn-secondary btn-small" id="toggleLabelsMain">
                                    <i class="fas fa-tag"></i> Etiquetas
                                </button>
                                <button class="btn btn-secondary btn-small" id="downloadChart">
                                    <i class="fas fa-download"></i> PNG
                                </button>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="mainChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-bar"></i> Resumen por Grupo</h3>
                            <div class="chart-controls">
                                <select id="barChartGroupBy" class="form-control" style="width: 150px;">
                                    <option value="grupo">Por Grupo</option>
                                    <option value="supervisor">Por Supervisor</option>
                                    <option value="zona">Por Zona</option>
                                </select>
                                <button class="btn btn-secondary btn-small" id="toggleLabelsBar">
                                    <i class="fas fa-tag"></i> Etiquetas
                                </button>
                                <button class="btn btn-secondary btn-small" id="downloadBarChart">
                                    <i class="fas fa-download"></i> PNG
                                </button>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>
                </section>
                
                <!-- Comparative Analysis -->
                <section class="comparative-section">
                    <div class="chart-header">
                        <h3><i class="fas fa-chart-area"></i> Análisis Comparativo</h3>
                        <div class="chart-controls">
                            <button class="btn btn-secondary btn-small" id="toggleLabelsComparative">
                                <i class="fas fa-tag"></i> Etiquetas
                            </button>
                            <button class="btn btn-secondary btn-small" id="downloadComparativeChart">
                                <i class="fas fa-download"></i> PNG
                            </button>
                        </div>
                    </div>
                    <div class="indicators-selector">
                        <h4>Seleccionar Indicadores para Comparar:</h4>
                        <div class="indicator-checkbox">
                            <input type="checkbox" id="comparePicada" value="picada" checked>
                            <label for="comparePicada">% Picada</label>
                        </div>
                        <div class="indicator-checkbox">
                            <input type="checkbox" id="compareMamones" value="mamones">
                            <label for="compareMamones">% Mamones</label>
                        </div>
                        <div class="indicator-checkbox">
                            <input type="checkbox" id="compareLalas" value="lalas">
                            <label for="compareLalas">% Lalas</label>
                        </div>
                        <div class="indicator-checkbox">
                            <input type="checkbox" id="compareTallosSecos" value="tallosSecos">
                            <label for="compareTallosSecos">% Tallos Secos</label>
                        </div>
                        <div class="indicator-checkbox">
                            <input type="checkbox" id="comparePunta" value="punta">
                            <label for="comparePunta">% Punta</label>
                        </div>
                        <button class="btn btn-primary btn-small" id="updateComparative">
                            <i class="fas fa-sync"></i> Actualizar
                        </button>
                    </div>
                    <div class="chart-wrapper" style="height: 300px;">
                        <canvas id="comparativeChart"></canvas>
                    </div>
                </section>
            </div>
            
            <!-- Analytics Tab -->
            <div id="analytics-tab" class="tab-content">
                <section class="data-section">
                    <h2 class="section-title"><i class="fas fa-chart-pie"></i> Análisis Detallado por Indicador</h2>
                    
                    <!-- Detailed Metrics Grid -->
                    <div class="metrics-grid" id="detailedMetricsGrid">
                        <!-- Detailed metrics will be dynamically generated -->
                    </div>
                    
                    <!-- Statistics Summary -->
                    <div style="margin-top: 30px; padding: 20px; background: #f9f9f9; border-radius: var(--border-radius);">
                        <h3><i class="fas fa-info-circle"></i> Resumen Estadístico</h3>
                        <div id="statisticsSummary" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                            <!-- Statistics will be dynamically generated -->
                        </div>
                    </div>
                </section>
            </div>
            
            <!-- Data Tab -->
            <div id="data-tab" class="tab-content">
                <section class="data-section">
                    <div class="chart-header">
                        <h3><i class="fas fa-table"></i> Datos Detallados</h3>
                        <div class="chart-controls">
                            <button class="btn btn-primary" id="downloadData">
                                <i class="fas fa-download"></i> Descargar CSV
                            </button>
                            <button class="btn btn-secondary" id="exportExcel">
                                <i class="fas fa-file-excel"></i> Exportar Excel
                            </button>
                        </div>
                    </div>
                    <div style="margin: 20px 0;">
                        <div class="alert" id="dataAlert" style="display: none;"></div>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table" id="dataTable">
                            <!-- Data will be dynamically populated -->
                        </table>
                    </div>
                    <div class="loading" id="tableLoading" style="display: none;">
                        <div class="spinner"></div>
                        <p>Cargando datos...</p>
                    </div>
                    <div id="paginationControls" style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span id="pageInfo">Página 1 de 1</span>
                        </div>
                        <div>
                            <button class="btn btn-secondary btn-small" id="prevPage" disabled>
                                <i class="fas fa-chevron-left"></i> Anterior
                            </button>
                            <button class="btn btn-secondary btn-small" id="nextPage" disabled>
                                Siguiente <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </section>
            </div>
            
            <!-- Reports Tab -->
            <div id="reports-tab" class="tab-content">
                <section class="data-section">
                    <h2 class="section-title"><i class="fas fa-file-pdf"></i> Generar Reportes</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div class="metric-card">
                            <h3><i class="fas fa-file-alt"></i> Reporte Resumen</h3>
                            <p>Genera un reporte PDF con un resumen ejecutivo de los KPIs principales.</p>
                            <button class="btn btn-primary" id="generateSummaryReport" style="margin-top: 15px;">
                                <i class="fas fa-file-pdf"></i> Generar Reporte
                            </button>
                        </div>
                        
                        <div class="metric-card">
                            <h3><i class="fas fa-chart-line"></i> Reporte de Tendencias</h3>
                            <p>Reporte detallado con gráficos de tendencias y análisis temporal.</p>
                            <button class="btn btn-primary" id="generateTrendReport" style="margin-top: 15px;">
                                <i class="fas fa-file-pdf"></i> Generar Reporte
                            </button>
                        </div>
                        
                        <div class="metric-card">
                            <h3><i class="fas fa-chart-bar"></i> Reporte Comparativo</h3>
                            <p>Análisis comparativo entre diferentes grupos, zonas o supervisores.</p>
                            <button class="btn btn-primary" id="generateComparativeReport" style="margin-top: 15px;">
                                <i class="fas fa-file-pdf"></i> Generar Reporte
                            </button>
                        </div>
                        
                        <div class="metric-card">
                            <h3><i class="fas fa-file-excel"></i> Datos Completos</h3>
                            <p>Exporta todos los datos filtrados en formato Excel para análisis externo.</p>
                            <button class="btn btn-success" id="exportFullData" style="margin-top: 15px;">
                                <i class="fas fa-file-excel"></i> Exportar Excel
                            </button>
                        </div>
                    </div>
                    
                    <!-- Report Configuration -->
                    <div style="margin-top: 30px; padding: 20px; background: #f9f9f9; border-radius: var(--border-radius);">
                        <h3><i class="fas fa-cog"></i> Configuración del Reporte</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                            <div class="form-group">
                                <label for="reportTitle">Título del Reporte</label>
                                <input type="text" id="reportTitle" class="form-control" value="Reporte de Calidad de Cosecha">
                            </div>
                            <div class="form-group">
                                <label for="reportDate">Fecha del Reporte</label>
                                <input type="date" id="reportDate" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="includeCharts">Incluir Gráficos</label>
                                <select id="includeCharts" class="form-control">
                                    <option value="yes">Sí</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" id="generateCustomReport">
                                <i class="fas fa-file-pdf"></i> Generar Reporte Personalizado
                            </button>
                        </div>
                    </div>
                </section>
            </div>
        </div>
        
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Procesando solicitud...</p>
        </div>
    </main>
    
    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <img src="https://www.gporres.com.mx/PFER/Images/Porres400x129.png" alt="Logo Porres" style="height: 40px; margin-bottom: 10px;">
                    <p>Sistema de Análisis de Calidad de Cosecha</p>
                    <p style="font-size: 0.8rem; opacity: 0.8;">© 2025 Porres Group. Todos los derechos reservados.</p>
                </div>
                <div class="footer-links">
                    <a href="#"><i class="fas fa-question-circle"></i> Ayuda</a>
                    <a href="#"><i class="fas fa-envelope"></i> Contacto</a>
                    <a href="#"><i class="fas fa-shield-alt"></i> Privacidad</a>
                </div>
            </div>
        </div>
    </footer>
    
    <script>
        // Configuración del Sistema
        const CONFIG = {
            GAS_URL: 'https://script.google.com/macros/s/AKfycbwCC87l5cdWR_gzjjLYFxcGnDlfRXVU7j03jCVEt7cAJ9E6o1-DGr3zUeCbVHZbrpH4/exec', // REEMPLAZA CON TU URL
            DATA_SHEET: 'Datos_CCA',
            colors: {
                good: '#4caf50',
                warning: '#ff9800',
                bad: '#f44336',
                primary: '#2e7d32',
                primaryLight: '#4caf50',
                primaryDark: '#1b5e20',
                neutral: '#607d8b'
            },
            thresholds: {
                impurezasTotales: { red: 10, yellow: 5 },
                picada: { red: 3, yellow: 1.5 },
                mamones: { red: 3, yellow: 1.5 },
                lalas: { red: 1, yellow: 0.5 },
                tallosSecos: { red: 2, yellow: 1 },
                tallosDaniados: { red: 1, yellow: 0.5 },
                raices: { red: 0.5, yellow: 0.2 },
                punta: { red: 5, yellow: 2.5 },
                tierra: { red: 1, yellow: 0.5 },
                piedra: { red: 0.2, yellow: 0.1 },
                puntaBasura: { red: 5, yellow: 2.5 },
                alturaCorte: { red: 10, yellow: 12 }, // Valores bajos son malos
                usoBandas: { red: 2, yellow: 3 }, // Valores bajos son malos
                pegadaCorte: { red: 3, yellow: 4 } // Valores bajos son malos
            },
            chartColors: [
                '#2e7d32', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b',
                '#ffc107', '#ff9800', '#ff5722', '#795548', '#9e9e9e',
                '#607d8b', '#2196f3', '#03a9f4', '#00bcd4', '#009688'
            ]
        };
        
        // Estado de la aplicación
        const AppState = {
            user: null,
            filters: {
                ingenio: 'Todos',
                grupo: 'Todos',
                supervisor: 'Todos',
                zona: 'Todos',
                semana: 'Todas',
                fechaInicio: '',
                fechaFin: ''
            },
            data: [],
            kpis: {},
            filtersData: {},
            currentPage: 1,
            pageSize: 50,
            charts: {},
            currentTab: 'dashboard-tab',
            showLabels: {
                mainChart: false,
                barChart: false,
                comparativeChart: false
            }
        };
        
        // Mapeo de nombres de indicadores
        const INDICATOR_NAMES = {
            muestrasTotales: 'Muestras Totales',
            impurezasTotales: 'Impurezas Totales',
            picada: '% Picada',
            mamones: '% Mamones',
            lalas: '% Lalas',
            tallosSecos: '% Tallos Secos',
            tallosDaniados: '% Tallos Dañados',
            raices: '% Raíces Adheridas',
            punta: '% Punta',
            tierra: '% Tierra',
            piedra: '% Piedra',
            puntaBasura: 'Punta en Basura (Kg)',
            alturaCorte: 'Altura de Corte (cm)',
            usoBandas: 'Uso de Bandas',
            pegadaCorte: 'Pegada de Corte (n°)'
        };
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si hay usuario en sesión
            const savedUser = localStorage.getItem('quality_user');
            if (savedUser) {
                AppState.user = JSON.parse(savedUser);
                showDashboard();
                initializeApp();
            } else {
                showLogin();
                // Establecer fecha actual por defecto
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('reportDate').value = today;
            }
            
            // Configurar event listeners
            setupEventListeners();
        });
        
        // Configurar event listeners
        function setupEventListeners() {
            // Login/Register
            document.getElementById('showRegister').addEventListener('click', showRegister);
            document.getElementById('showLogin').addEventListener('click', showLogin);
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });
            
            // Dashboard
            document.getElementById('applyFilters').addEventListener('click', applyFilters);
            document.getElementById('resetFilters').addEventListener('click', resetFilters);
            document.getElementById('refreshData').addEventListener('click', refreshAllData);
            document.getElementById('chartIndicator').addEventListener('change', updateMainChart);
            document.getElementById('chartGroupBy').addEventListener('change', updateMainChart);
            document.getElementById('barChartGroupBy').addEventListener('change', updateBarChart);
            document.getElementById('updateComparative').addEventListener('click', updateComparativeChart);
            document.getElementById('downloadChart').addEventListener('click', () => downloadChart('mainChart'));
            document.getElementById('downloadBarChart').addEventListener('click', () => downloadChart('barChart'));
            document.getElementById('downloadComparativeChart').addEventListener('click', () => downloadChart('comparativeChart'));
            
            // Toggle labels
            document.getElementById('toggleLabelsMain').addEventListener('click', () => toggleChartLabels('mainChart'));
            document.getElementById('toggleLabelsBar').addEventListener('click', () => toggleChartLabels('barChart'));
            document.getElementById('toggleLabelsComparative').addEventListener('click', () => toggleChartLabels('comparativeChart'));
            
            // Data Tab
            document.getElementById('downloadData').addEventListener('click', downloadDataAsCSV);
            document.getElementById('exportExcel').addEventListener('click', exportToExcel);
            document.getElementById('prevPage').addEventListener('click', previousPage);
            document.getElementById('nextPage').addEventListener('click', nextPage);
            
            // Reports Tab
            document.getElementById('generateSummaryReport').addEventListener('click', () => generateReport('summary'));
            document.getElementById('generateTrendReport').addEventListener('click', () => generateReport('trend'));
            document.getElementById('generateComparativeReport').addEventListener('click', () => generateReport('comparative'));
            document.getElementById('exportFullData').addEventListener('click', exportFullData);
            document.getElementById('generateCustomReport').addEventListener('click', generateCustomReport);
            
            // Checkboxes comparativos
            document.querySelectorAll('.indicator-checkbox input').forEach(checkbox => {
                checkbox.addEventListener('change', updateComparativeChart);
            });
        }
        
        // Funciones de navegación
        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('registerScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('userName').textContent = 'Invitado';
            document.getElementById('logoutBtn').style.display = 'none';
        }
        
        function showRegister() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('registerScreen').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
        }
        
        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('registerScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('userName').textContent = AppState.user.name;
            document.getElementById('logoutBtn').style.display = 'block';
        }
        
        function switchTab(tabId) {
            // Actualizar tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Activar tab seleccionado
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
            AppState.currentTab = tabId;
            
            // Cargar datos específicos del tab si es necesario
            if (tabId === 'analytics-tab') {
                loadDetailedMetrics();
            } else if (tabId === 'data-tab') {
                loadDataTable();
            }
        }
        
        // Inicializar aplicación
        async function initializeApp() {
            showLoading();
            try {
                // Cargar filtros disponibles
                await loadFilters();
                
                // Cargar todos los datos iniciales
                await loadAllData();
                
                // Renderizar componentes
                renderFilters();
                renderKPIs();
                updateAllCharts();
                
            } catch (error) {
                console.error('Error inicializando app:', error);
                showAlert('loginAlert', 'error', 'Error cargando datos iniciales');
            } finally {
                hideLoading();
            }
        }
        
        // Manejar login
        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            showLoading();
            
            try {
                const response = await fetchGAS('login', { username, password });
                
                if (response.success) {
                    AppState.user = response.user;
                    localStorage.setItem('quality_user', JSON.stringify(response.user));
                    showAlert('loginAlert', 'success', 'Login exitoso');
                    showDashboard();
                    initializeApp();
                } else {
                    showAlert('loginAlert', 'error', response.message || 'Error en login');
                }
            } catch (error) {
                showAlert('loginAlert', 'error', 'Error de conexión con el servidor');
                console.error('Error en login:', error);
            } finally {
                hideLoading();
            }
        }
        
        // Manejar registro
        async function handleRegister(e) {
            e.preventDefault();
            
            const name = document.getElementById('registerName').value;
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            if (password !== confirmPassword) {
                showAlert('registerAlert', 'error', 'Las contraseñas no coinciden');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetchGAS('register', { 
                    username, 
                    password, 
                    name, 
                    email 
                });
                
                if (response.success) {
                    showAlert('registerAlert', 'success', response.message);
                    setTimeout(() => showLogin(), 2000);
                } else {
                    showAlert('registerAlert', 'error', response.message || 'Error en registro');
                }
            } catch (error) {
                showAlert('registerAlert', 'error', 'Error de conexión con el servidor');
            } finally {
                hideLoading();
            }
        }
        
        // Manejar logout
        function handleLogout() {
            AppState.user = null;
            localStorage.removeItem('quality_user');
            showLogin();
            // Limpiar charts
            Object.values(AppState.charts).forEach(chart => {
                if (chart && chart.destroy) chart.destroy();
            });
            AppState.charts = {};
        }
        
        // Cargar filtros disponibles
        async function loadFilters() {
            try {
                const response = await fetchGAS('getFilters');
                
                if (response.success) {
                    AppState.filtersData = response.filters;
                    return true;
                } else {
                    throw new Error(response.message);
                }
            } catch (error) {
                console.error('Error cargando filtros:', error);
                return false;
            }
        }
        
        // Renderizar filtros en la UI
        function renderFilters() {
            const filtersGrid = document.getElementById('filtersGrid');
            
            if (!AppState.filtersData.ingenios) {
                filtersGrid.innerHTML = '<div class="alert alert-error">Error cargando filtros</div>';
                return;
            }
            
            filtersGrid.innerHTML = `
                <div class="form-group">
                    <label for="filterIngenio">Ingenio</label>
                    <select id="filterIngenio" class="form-control">
                        ${AppState.filtersData.ingenios.map(ingenio => 
                            `<option value="${ingenio}">${ingenio}</option>`
                        ).join('')}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="filterGrupo">Grupo de Cosecha</label>
                    <select id="filterGrupo" class="form-control">
                        ${AppState.filtersData.grupos.map(grupo => 
                            `<option value="${grupo}">${grupo}</option>`
                        ).join('')}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="filterSupervisor">Supervisor de Cosecha</label>
                    <select id="filterSupervisor" class="form-control">
                        ${AppState.filtersData.supervisores.map(supervisor => 
                            `<option value="${supervisor}">${supervisor}</option>`
                        ).join('')}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="filterZona">Zona</label>
                    <select id="filterZona" class="form-control">
                        ${AppState.filtersData.zonas.map(zona => 
                            `<option value="${zona}">${zona}</option>`
                        ).join('')}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="filterSemana">Semana de Evaluación</label>
                    <select id="filterSemana" class="form-control">
                        ${AppState.filtersData.semanas.map(semana => 
                            `<option value="${semana}">${semana}</option>`
                        ).join('')}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="filterFechaInicio">Fecha Inicio</label>
                    <input type="date" id="filterFechaInicio" class="form-control" 
                           value="${AppState.filtersData.fechaMin || ''}">
                </div>
                
                <div class="form-group">
                    <label for="filterFechaFin">Fecha Fin</label>
                    <input type="date" id="filterFechaFin" class="form-control" 
                           value="${AppState.filtersData.fechaMax || ''}">
                </div>
            `;
            
            // Establecer valores actuales de filtros
            document.getElementById('filterIngenio').value = AppState.filters.ingenio;
            document.getElementById('filterGrupo').value = AppState.filters.grupo;
            document.getElementById('filterSupervisor').value = AppState.filters.supervisor;
            document.getElementById('filterZona').value = AppState.filters.zona;
            document.getElementById('filterSemana').value = AppState.filters.semana;
            document.getElementById('filterFechaInicio').value = AppState.filters.fechaInicio || AppState.filtersData.fechaMin;
            document.getElementById('filterFechaFin').value = AppState.filters.fechaFin || AppState.filtersData.fechaMax;
        }
        
        // Aplicar filtros
        async function applyFilters() {
            // Obtener valores de filtros
            AppState.filters = {
                ingenio: document.getElementById('filterIngenio').value,
                grupo: document.getElementById('filterGrupo').value,
                supervisor: document.getElementById('filterSupervisor').value,
                zona: document.getElementById('filterZona').value,
                semana: document.getElementById('filterSemana').value,
                fechaInicio: document.getElementById('filterFechaInicio').value,
                fechaFin: document.getElementById('filterFechaFin').value
            };
            
            // Cargar datos con nuevos filtros
            await refreshAllData();
        }
        
        // Resetear filtros
        function resetFilters() {
            AppState.filters = {
                ingenio: 'Todos',
                grupo: 'Todos',
                supervisor: 'Todos',
                zona: 'Todos',
                semana: 'Todas',
                fechaInicio: AppState.filtersData.fechaMin || '',
                fechaFin: AppState.filtersData.fechaMax || ''
            };
            
            renderFilters();
            refreshAllData();
        }
        
        // Refrescar todos los datos
        async function refreshAllData() {
            showLoading();
            try {
                await loadAllData();
                renderKPIs();
                updateAllCharts();
                if (AppState.currentTab === 'analytics-tab') {
                    loadDetailedMetrics();
                }
                if (AppState.currentTab === 'data-tab') {
                    loadDataTable();
                }
                showAlert('dataAlert', 'success', `Datos actualizados: ${AppState.data.length} registros encontrados`);
            } catch (error) {
                console.error('Error refrescando datos:', error);
                showAlert('dataAlert', 'error', 'Error actualizando datos');
            } finally {
                hideLoading();
            }
        }
        
        // Cargar todos los datos
        async function loadAllData() {
            try {
                // Cargar KPIs
                const kpiResponse = await fetchGAS('getKPIs', AppState.filters);
                
                if (kpiResponse.success) {
                    AppState.kpis = kpiResponse.kpis;
                } else {
                    throw new Error(kpiResponse.message);
                }
                
                // Cargar datos completos
                const dataResponse = await fetchGAS('getData', AppState.filters);
                
                if (dataResponse.success) {
                    AppState.data = dataResponse.data;
                    AppState.currentPage = 1;
                } else {
                    throw new Error(dataResponse.message);
                }
                
                return true;
            } catch (error) {
                console.error('Error cargando datos:', error);
                return false;
            }
        }
        
        // Renderizar KPIs con las modificaciones solicitadas
        function renderKPIs() {
            const kpiGrid = document.getElementById('kpiGrid');
            
            if (!AppState.kpis || Object.keys(AppState.kpis).length === 0) {
                kpiGrid.innerHTML = '<div class="alert alert-error">No hay datos disponibles</div>';
                return;
            }
            
            // KPIs principales con las modificaciones solicitadas
            const mainKPIs = [
                { 
                    id: 'muestrasTotales', 
                    title: 'Muestras Totales', 
                    icon: 'fas fa-clipboard-list', 
                    format: 'number',
                    color: CONFIG.colors.neutral, // Color neutro para informativo
                    showStatus: false // No mostrar estado de semáforo
                },
                { 
                    id: 'impurezasTotales', 
                    title: 'Impurezas Totales', 
                    icon: 'fas fa-trash', 
                    format: 'percent',
                    color: getColorForIndicator('impurezasTotales', AppState.kpis.impurezasTotales || 0),
                    showStatus: true
                },
                { 
                    id: 'picada', 
                    title: '% Picada', 
                    icon: 'fas fa-cut', 
                    format: 'percent',
                    color: getColorForIndicator('picada', AppState.kpis.picada || 0),
                    showStatus: true
                },
                { 
                    id: 'mamones', 
                    title: '% Mamones', 
                    icon: 'fas fa-tree', 
                    format: 'percent',
                    color: getColorForIndicator('mamones', AppState.kpis.mamones || 0),
                    showStatus: true
                },
                { 
                    id: 'puntaBasura', 
                    title: 'Punta en Basura', 
                    icon: 'fas fa-leaf', 
                    format: 'kg',
                    color: getColorForIndicator('puntaBasura', AppState.kpis.puntaBasura || 0),
                    showStatus: false
                },
                { 
                    id: 'alturaCorte', 
                    title: 'Altura de Corte', 
                    icon: 'fas fa-ruler-vertical', 
                    format: 'cm',
                    color: getColorForIndicator('alturaCorte', AppState.kpis.alturaCorte || 0),
                    showStatus: false
                },
                { 
                    id: 'usoBandas', 
                    title: 'Uso de Bandas', 
                    icon: 'fas fa-band-aid', 
                    format: 'number',
                    color: getColorForIndicator('usoBandas', AppState.kpis.usoBandas || 0),
                    showStatus: false,
                    noUnit: true // Sin unidad de medida
                },
                { 
                    id: 'pegadaCorte', 
                    title: 'Pegada de Corte', 
                    icon: 'fas fa-cut', 
                    format: 'number',
                    color: getColorForIndicator('pegadaCorte', AppState.kpis.pegadaCorte || 0),
                    showStatus: false
                }
            ];
            
            kpiGrid.innerHTML = mainKPIs.map(kpi => {
                if (!AppState.kpis.hasOwnProperty(kpi.id)) return '';
                
                const value = AppState.kpis[kpi.id];
                const borderColor = kpi.color;
                const formattedValue = formatKPIValue(value, kpi.format, kpi.noUnit);
                
                return `
                    <div class="kpi-card" style="border-left: 5px solid ${borderColor}">
                        <div class="kpi-header">
                            <div class="kpi-title">${kpi.title}</div>
                            <div class="kpi-icon" style="color: ${borderColor}"><i class="${kpi.icon}"></i></div>
                        </div>
                        <div class="kpi-value">${formattedValue}</div>
                        <div class="kpi-subtitle">
                            ${kpi.showStatus ? getIndicatorStatus(kpi.id, value) : 'Indicador informativo'}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Obtener color para indicador según los umbrales especificados
        function getColorForIndicator(indicator, value) {
            const threshold = CONFIG.thresholds[indicator];
            if (!threshold) return CONFIG.colors.primary;
            
            // Para impurezas totales, picada y mamones: rojo si > 3%
            if (['impurezasTotales', 'picada', 'mamones'].includes(indicator)) {
                return value > 3 ? CONFIG.colors.bad : 
                       value > 1.5 ? CONFIG.colors.warning : CONFIG.colors.good;
            }
            
            // Para altura de corte, uso de bandas y pegada de corte, valores altos son buenos
            if (['alturaCorte', 'usoBandas', 'pegadaCorte'].includes(indicator)) {
                return value >= threshold.yellow ? CONFIG.colors.good : 
                       value >= threshold.red ? CONFIG.colors.warning : CONFIG.colors.bad;
            } else {
                // Para el resto, valores bajos son buenos
                return value <= threshold.yellow ? CONFIG.colors.good : 
                       value <= threshold.red ? CONFIG.colors.warning : CONFIG.colors.bad;
            }
        }
        
        // Formatear valor KPI
        function formatKPIValue(value, format, noUnit = false) {
            if (value === undefined || value === null) return 'N/A';
            
            let formattedValue;
            switch(format) {
                case 'percent': 
                    formattedValue = value.toFixed(2);
                    return noUnit ? formattedValue : `${formattedValue}%`;
                case 'kg': 
                    formattedValue = value.toFixed(2);
                    return `${formattedValue} kg`;
                case 'cm': 
                    formattedValue = value.toFixed(1);
                    return `${formattedValue} cm`;
                case 'number': 
                    formattedValue = value.toFixed(noUnit ? 2 : 0);
                    return noUnit ? formattedValue : formattedValue.toLocaleString();
                default: 
                    return value.toString();
            }
        }
        
        // Obtener estado del indicador
        function getIndicatorStatus(indicator, value) {
            const color = getColorForIndicator(indicator, value);
            if (color === CONFIG.colors.good) return '✅ Bueno';
            if (color === CONFIG.colors.warning) return '⚠️ Regular';
            return '❌ Crítico';
        }
        
        // Cargar métricas detalladas
        async function loadDetailedMetrics() {
            const metricsGrid = document.getElementById('detailedMetricsGrid');
            const statsSummary = document.getElementById('statisticsSummary');
            
            try {
                const response = await fetchGAS('getAllMetrics', AppState.filters);
                
                if (response.success) {
                    const metrics = response.metrics;
                    const stats = response.estadisticas;
                    
                    // Renderizar todas las métricas de impurezas
                    const impurityMetrics = [
                        { id: 'picada', title: '% Picada', icon: 'fas fa-cut' },
                        { id: 'mamones', title: '% Mamones', icon: 'fas fa-tree' },
                        { id: 'lalas', title: '% Lalas', icon: 'fas fa-leaf' },
                        { id: 'tallosSecos', title: '% Tallos Secos', icon: 'fas fa-fire' },
                        { id: 'tallosDaniados', title: '% Tallos Dañados', icon: 'fas fa-bug' },
                        { id: 'raices', title: '% Raíces Adheridas', icon: 'fas fa-root' },
                        { id: 'punta', title: '% Punta', icon: 'fas fa-arrow-up' },
                        { id: 'tierra', title: '% Tierra', icon: 'fas fa-mountain' },
                        { id: 'piedra', title: '% Piedra', icon: 'fas fa-gem' }
                    ];
                    
                    metricsGrid.innerHTML = impurityMetrics.map(metric => {
                        if (!metrics.hasOwnProperty(metric.id)) return '';
                        
                        const value = metrics[metric.id];
                        const color = getColorForIndicator(metric.id, value);
                        const maxValue = 10; // Máximo 10% para escalar la barra
                        
                        return `
                            <div class="metric-card">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h4><i class="${metric.icon}"></i> ${metric.title}</h4>
                                    <span style="font-weight: bold; color: ${color}">
                                        ${value.toFixed(2)}%
                                    </span>
                                </div>
                                <div style="height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin-bottom: 5px;">
                                    <div style="height: 100%; width: ${Math.min((value / maxValue) * 100, 100)}%; 
                                         background: ${color}; border-radius: 5px;">
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #666;">
                                    <span>0%</span>
                                    <span>10%</span>
                                </div>
                                <div style="margin-top: 10px; font-size: 0.9rem; color: ${color}; font-weight: 600;">
                                    ${getIndicatorStatus(metric.id, value)}
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // Renderizar resumen estadístico
                    statsSummary.innerHTML = `
                        <div>
                            <strong>Total de Muestras:</strong> ${stats.totalMuestras}
                        </div>
                        <div>
                            <strong>Período:</strong> ${stats.fechaMin} al ${stats.fechaMax}
                        </div>
                        <div>
                            <strong>Ingenios Únicos:</strong> ${stats.ingeniosUnicos?.length || 0}
                        </div>
                        <div>
                            <strong>Grupos Únicos:</strong> ${stats.gruposUnicos?.length || 0}
                        </div>
                        <div>
                            <strong>Última Actualización:</strong> ${new Date(response.timestamp).toLocaleString()}
                        </div>
                    `;
                    
                } else {
                    throw new Error(response.message);
                }
            } catch (error) {
                console.error('Error cargando métricas detalladas:', error);
                metricsGrid.innerHTML = '<div class="alert alert-error">Error cargando métricas detalladas</div>';
            }
        }
        
        // Cargar tabla de datos
        async function loadDataTable() {
            const table = document.getElementById('dataTable');
            const loading = document.getElementById('tableLoading');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            
            loading.style.display = 'flex';
            table.innerHTML = '';
            
            try {
                if (AppState.data.length === 0) {
                    await loadAllData();
                }
                
                if (AppState.data.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="10" style="text-align: center; padding: 40px;">
                                No hay datos para los filtros seleccionados
                            </td>
                        </tr>
                    `;
                    pageInfo.textContent = 'Página 1 de 1';
                    prevBtn.disabled = true;
                    nextBtn.disabled = true;
                    return;
                }
                
                // Calcular paginación
                const totalPages = Math.ceil(AppState.data.length / AppState.pageSize);
                const startIndex = (AppState.currentPage - 1) * AppState.pageSize;
                const endIndex = Math.min(startIndex + AppState.pageSize, AppState.data.length);
                const pageData = AppState.data.slice(startIndex, endIndex);
                
                // Crear encabezados (usar las primeras columnas importantes)
                const headers = AppState.data.length > 0 ? Object.keys(AppState.data[0]) : [];
                const displayHeaders = headers.slice(0, 10); // Mostrar solo las primeras 10 columnas
                
                let thead = `<tr>${displayHeaders.map(header => `<th>${header}</th>`).join('')}</tr>`;
                
                // Crear filas
                let tbody = '';
                pageData.forEach(row => {
                    tbody += `<tr>${displayHeaders.map(header => 
                        `<td>${formatTableCell(row[header])}</td>`
                    ).join('')}</tr>`;
                });
                
                table.innerHTML = thead + tbody;
                
                // Actualizar controles de paginación
                pageInfo.textContent = `Página ${AppState.currentPage} de ${totalPages} (${AppState.data.length} registros)`;
                prevBtn.disabled = AppState.currentPage <= 1;
                nextBtn.disabled = AppState.currentPage >= totalPages;
                
            } catch (error) {
                console.error('Error cargando tabla:', error);
                table.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #f44336;">
                            Error cargando datos
                        </td>
                    </tr>
                `;
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // Funciones de paginación
        function previousPage() {
            if (AppState.currentPage > 1) {
                AppState.currentPage--;
                loadDataTable();
            }
        }
        
        function nextPage() {
            const totalPages = Math.ceil(AppState.data.length / AppState.pageSize);
            if (AppState.currentPage < totalPages) {
                AppState.currentPage++;
                loadDataTable();
            }
        }
        
        // Actualizar todos los gráficos
        function updateAllCharts() {
            updateMainChart();
            updateBarChart();
            updateComparativeChart();
        }
        
        // Actualizar gráfico principal
        async function updateMainChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const indicator = document.getElementById('chartIndicator').value;
            const groupBy = document.getElementById('chartGroupBy').value;
            
            // Destruir gráfico anterior si existe
            if (AppState.charts.main) {
                AppState.charts.main.destroy();
            }
            
            try {
                const response = await fetchGAS('getTimeSeries', {
                    ...AppState.filters,
                    indicator: indicator,
                    agrupacion: groupBy
                });
                
                if (!response.success) {
                    throw new Error(response.message);
                }
                
                const data = response.data;
                const labels = response.labels;
                const color = getColorForIndicator(indicator, data[data.length - 1] || 0);
                
                AppState.charts.main = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: INDICATOR_NAMES[indicator] || indicator,
                            data: data,
                            borderColor: color,
                            backgroundColor: color + '20',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: color,
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.y;
                                        const unit = indicator.includes('%') ? '%' : 
                                                     indicator === 'puntaBasura' ? ' kg' :
                                                     indicator === 'alturaCorte' ? ' cm' : '';
                                        return `${label}: ${value.toFixed(2)}${unit}`;
                                    }
                                }
                            },
                            datalabels: {
                                display: AppState.showLabels.mainChart,
                                color: '#333',
                                font: {
                                    weight: 'bold',
                                    size: 10
                                },
                                formatter: function(value) {
                                    return value.toFixed(1);
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: indicator.includes('%') ? 'Porcentaje (%)' : 
                                          indicator === 'puntaBasura' ? 'Kilogramos (kg)' :
                                          indicator === 'alturaCorte' ? 'Centímetros (cm)' : 'Valor'
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0,0,0,0.05)'
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            } catch (error) {
                console.error('Error actualizando gráfico principal:', error);
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.fillText('Error cargando datos del gráfico', 10, 50);
            }
        }
        
        // Actualizar gráfico de barras con colores semaforizados
        async function updateBarChart() {
            const ctx = document.getElementById('barChart').getContext('2d');
            const groupBy = document.getElementById('barChartGroupBy').value;
            const indicator = 'impurezasTotales'; // Por defecto mostrar impurezas
            
            // Destruir gráfico anterior si existe
            if (AppState.charts.bar) {
                AppState.charts.bar.destroy();
            }
            
            try {
                const response = await fetchGAS('getGroupAnalysis', {
                    ...AppState.filters,
                    indicator: indicator,
                    agrupacion: groupBy
                });
                
                if (!response.success) {
                    throw new Error(response.message);
                }
                
                const analysis = response.analysis;
                const labels = analysis.map(item => item.grupo);
                const data = analysis.map(item => item.valor);
                const colors = analysis.map(item => item.color);
                
                // Limitar a 15 grupos para mejor visualización
                const displayLimit = 15;
                const displayLabels = labels.slice(0, displayLimit);
                const displayData = data.slice(0, displayLimit);
                const displayColors = colors.slice(0, displayLimit);
                
                AppState.charts.bar = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: displayLabels,
                        datasets: [{
                            label: INDICATOR_NAMES[indicator] || indicator,
                            data: displayData,
                            backgroundColor: displayColors,
                            borderColor: displayColors.map(color => color),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.x.toFixed(2)}%`;
                                    }
                                }
                            },
                            datalabels: {
                                display: AppState.showLabels.barChart,
                                color: '#333',
                                font: {
                                    weight: 'bold',
                                    size: 10
                                },
                                anchor: 'end',
                                align: 'right',
                                formatter: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Porcentaje (%)'
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.05)'
                                }
                            },
                            y: {
                                grid: {
                                    color: 'rgba(0,0,0,0.05)'
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            } catch (error) {
                console.error('Error actualizando gráfico de barras:', error);
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.fillText('Error cargando datos del gráfico', 10, 50);
            }
        }
        
        // Actualizar gráfico comparativo
        async function updateComparativeChart() {
            const ctx = document.getElementById('comparativeChart').getContext('2d');
            
            // Obtener indicadores seleccionados
            const selectedIndicators = [];
            document.querySelectorAll('.indicator-checkbox input:checked').forEach(checkbox => {
                selectedIndicators.push(checkbox.value);
            });
            
            if (selectedIndicators.length === 0) {
                if (AppState.charts.comparative) {
                    AppState.charts.comparative.destroy();
                }
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.fillText('Seleccione al menos un indicador para comparar', 10, 50);
                return;
            }
            
            // Destruir gráfico anterior si existe
            if (AppState.charts.comparative) {
                AppState.charts.comparative.destroy();
            }
            
            try {
                // Para cada indicador, obtener datos de series temporales
                const promises = selectedIndicators.map(async (indicator, index) => {
                    const response = await fetchGAS('getTimeSeries', {
                        ...AppState.filters,
                        indicator: indicator,
                        agrupacion: 'semana'
                    });
                    
                    if (response.success) {
                        return {
                            label: INDICATOR_NAMES[indicator] || indicator,
                            data: response.data,
                            labels: response.labels,
                            color: CONFIG.chartColors[index % CONFIG.chartColors.length]
                        };
                    }
                    return null;
                });
                
                const datasets = await Promise.all(promises);
                const validDatasets = datasets.filter(d => d !== null);
                
                if (validDatasets.length === 0) {
                    throw new Error('No se pudieron cargar los datos');
                }
                
                // Usar las etiquetas del primer dataset
                const labels = validDatasets[0].labels;
                
                AppState.charts.comparative = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: validDatasets.map(dataset => ({
                            label: dataset.label,
                            data: dataset.data,
                            borderColor: dataset.color,
                            backgroundColor: dataset.color + '20',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.y;
                                        const unit = context.dataset.label.includes('%') ? '%' : '';
                                        return `${label}: ${value.toFixed(2)}${unit}`;
                                    }
                                }
                            },
                            datalabels: {
                                display: AppState.showLabels.comparativeChart,
                                color: '#333',
                                font: {
                                    weight: 'bold',
                                    size: 8
                                },
                                formatter: function(value) {
                                    return value.toFixed(1);
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Porcentaje (%)'
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0,0,0,0.05)'
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            } catch (error) {
                console.error('Error actualizando gráfico comparativo:', error);
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.fillText('Error cargando datos del gráfico', 10, 50);
            }
        }
        
        // Alternar etiquetas de gráficos
        function toggleChartLabels(chartName) {
            AppState.showLabels[chartName] = !AppState.showLabels[chartName];
            
            if (AppState.charts[chartName]) {
                AppState.charts[chartName].options.plugins.datalabels.display = AppState.showLabels[chartName];
                AppState.charts[chartName].update();
                
                // Actualizar texto del botón
                const button = document.getElementById(`toggleLabels${chartName.charAt(0).toUpperCase() + chartName.slice(1)}`);
                if (button) {
                    const icon = button.querySelector('i');
                    const text = AppState.showLabels[chartName] ? 'Ocultar Etiquetas' : 'Mostrar Etiquetas';
                    icon.className = AppState.showLabels[chartName] ? 'fas fa-eye-slash' : 'fas fa-tag';
                    button.innerHTML = `<i class="${icon.className}"></i> ${text}`;
                }
            }
        }
        
        // Funciones de exportación
        function downloadDataAsCSV() {
            if (AppState.data.length === 0) {
                showAlert('dataAlert', 'error', 'No hay datos para descargar');
                return;
            }
            
            const headers = Object.keys(AppState.data[0]);
            const csvContent = [
                headers.join(','),
                ...AppState.data.map(row => 
                    headers.map(header => 
                        `"${(row[header] || '').toString().replace(/"/g, '""')}"`
                    ).join(',')
                )
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `datos_calidad_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('dataAlert', 'success', 'Datos descargados como CSV');
        }
        
        function exportToExcel() {
            if (AppState.data.length === 0) {
                showAlert('dataAlert', 'error', 'No hay datos para exportar');
                return;
            }
            
            // Convertir datos a hoja de trabajo
            const ws = XLSX.utils.json_to_sheet(AppState.data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Datos Calidad");
            
            // Generar archivo Excel
            XLSX.writeFile(wb, `datos_calidad_${new Date().toISOString().slice(0,10)}.xlsx`);
            
            showAlert('dataAlert', 'success', 'Datos exportados a Excel');
        }
        
        function exportFullData() {
            exportToExcel();
        }
        
        // Funciones de generación de reportes
        async function generateReport(reportType) {
            showLoading();
            try {
                const response = await fetchGAS('generateReport', {
                    reportType: reportType,
                    reportData: {
                        filters: AppState.filters,
                        user: AppState.user
                    }
                });
                
                if (response.success) {
                    // Crear PDF con los datos del reporte
                    await generatePDFReport(response.report);
                    showAlert('dataAlert', 'success', response.message);
                } else {
                    throw new Error(response.message);
                }
            } catch (error) {
                console.error('Error generando reporte:', error);
                showAlert('dataAlert', 'error', 'Error generando reporte: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        async function generateCustomReport() {
            const title = document.getElementById('reportTitle').value;
            const date = document.getElementById('reportDate').value;
            const includeCharts = document.getElementById('includeCharts').value === 'yes';
            
            showLoading();
            try {
                const reportData = {
                    type: 'custom',
                    title: title,
                    date: date,
                    includeCharts: includeCharts,
                    filters: AppState.filters,
                    kpis: AppState.kpis,
                    user: AppState.user
                };
                
                // Generar PDF personalizado
                await generatePDFReport(reportData);
                showAlert('dataAlert', 'success', 'Reporte personalizado generado exitosamente');
            } catch (error) {
                console.error('Error generando reporte personalizado:', error);
                showAlert('dataAlert', 'error', 'Error generando reporte personalizado');
            } finally {
                hideLoading();
            }
        }
        
        async function generatePDFReport(reportData) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Configuración inicial
                const pageWidth = doc.internal.pageSize.width;
                const margin = 20;
                const contentWidth = pageWidth - (margin * 2);
                
                // Logo (intentamos cargarlo)
                try {
                    const logoImg = new Image();
                    logoImg.crossOrigin = 'Anonymous';
                    logoImg.src = 'https://www.gporres.com.mx/PFER/Images/Porres400x129.png';
                    
                    await new Promise((resolve) => {
                        logoImg.onload = resolve;
                        logoImg.onerror = resolve; // Continuar incluso si falla
                    });
                    
                    // Agregar logo si se cargó correctamente
                    const logoWidth = 60;
                    const logoHeight = (logoWidth * 129) / 400; // Mantener proporción
                    doc.addImage(logoImg, 'PNG', margin, 10, logoWidth, logoHeight);
                } catch (logoError) {
                    console.log('No se pudo cargar el logo:', logoError);
                }
                
                // Título
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(reportData.title || 'Reporte de Calidad de Cosecha', margin, 40);
                
                // Información del reporte
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(`Fecha: ${new Date(reportData.date || Date.now()).toLocaleDateString('es-MX')}`, margin, 50);
                doc.text(`Generado por: ${AppState.user?.name || 'Usuario'}`, margin, 57);
                
                // Resumen ejecutivo
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Resumen Ejecutivo', margin, 70);
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                let yPos = 78;
                
                if (reportData.metrics) {
                    const metrics = reportData.metrics;
                    const importantMetrics = [
                        { label: 'Muestras Totales', value: metrics.muestrasTotales, unit: '' },
                        { label: 'Impurezas Totales', value: metrics.impurezasTotales, unit: '%' },
                        { label: '% Picada', value: metrics.picada, unit: '%' },
                        { label: '% Mamones', value: metrics.mamones, unit: '%' },
                        { label: 'Altura de Corte', value: metrics.alturaCorte, unit: 'cm' }
                    ];
                    
                    importantMetrics.forEach(metric => {
                        if (metric.value !== undefined) {
                            const text = `${metric.label}: ${metric.value.toFixed(2)}${metric.unit}`;
                            doc.text(text, margin, yPos);
                            yPos += 7;
                        }
                    });
                }
                
                // Filtros aplicados
                yPos += 5;
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('Filtros Aplicados', margin, yPos);
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                yPos += 8;
                
                Object.keys(AppState.filters).forEach(key => {
                    if (AppState.filters[key] && AppState.filters[key] !== 'Todos' && AppState.filters[key] !== 'Todas') {
                        const filterText = `${key}: ${AppState.filters[key]}`;
                        doc.text(filterText, margin, yPos);
                        yPos += 7;
                    }
                });
                
                // Recomendaciones
                yPos += 10;
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('Recomendaciones', margin, yPos);
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                yPos += 8;
                
                const recommendations = [
                    '1. Monitorear constantemente los niveles de impurezas',
                    '2. Capacitar al personal en técnicas de corte adecuadas',
                    '3. Revisar el mantenimiento del equipo de cosecha',
                    '4. Implementar controles de calidad más estrictos'
                ];
                
                recommendations.forEach(rec => {
                    doc.text(rec, margin, yPos);
                    yPos += 7;
                });
                
                // Pie de página
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.text(`Página ${i} de ${totalPages}`, pageWidth - margin, doc.internal.pageSize.height - 10);
                    doc.text(`Generado el: ${new Date().toLocaleString('es-MX')}`, margin, doc.internal.pageSize.height - 10);
                }
                
                // Guardar PDF
                const fileName = `reporte_${reportData.type || 'calidad'}_${new Date().toISOString().slice(0,10)}.pdf`;
                doc.save(fileName);
                
            } catch (error) {
                console.error('Error generando PDF:', error);
                throw error;
            }
        }
        
        // Función para descargar gráfico
        function downloadChart(chartName) {
            if (!AppState.charts[chartName]) {
                showAlert('dataAlert', 'error', 'No hay gráfico para descargar');
                return;
            }
            
            const link = document.createElement('a');
            link.download = `${chartName}_${new Date().toISOString().slice(0,10)}.png`;
            link.href = AppState.charts[chartName].toBase64Image();
            link.click();
            
            showAlert('dataAlert', 'success', 'Gráfico descargado como PNG');
        }
        
        // Función para hacer fetch al Google Apps Script
        async function fetchGAS(action, params = {}) {
            const url = new URL(CONFIG.GAS_URL);
            
            // Agregar parámetros
            url.searchParams.append('action', action);
            Object.keys(params).forEach(key => {
                if (params[key] !== undefined && params[key] !== null && params[key] !== '') {
                    url.searchParams.append(key, params[key]);
                }
            });
            
            // Agregar timestamp para evitar caché
            url.searchParams.append('_t', Date.now());
            
            try {
                const response = await fetch(url.toString(), {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error en fetchGAS:', error);
                throw error;
            }
        }
        
        // Funciones de utilidad
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        function showAlert(elementId, type, message) {
            const alertDiv = document.getElementById(elementId);
            if (!alertDiv) return;
            
            alertDiv.innerHTML = `
                <div class="alert alert-${type}">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    ${message}
                </div>
            `;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }
        
        function formatTableCell(value) {
            if (value === null || value === undefined) return '';
            if (typeof value === 'number') {
                return value.toFixed(2);
            }
            return value.toString();
        }
    </script>
</body>
</html>
